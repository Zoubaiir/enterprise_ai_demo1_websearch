{"version":3,"file":"content.js","mappings":"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","sources":["webpack://ai-car-shopping-extension/./src/presentation/content/messaging.ts","webpack://ai-car-shopping-extension/./src/presentation/content/facebook.extractor.ts","webpack://ai-car-shopping-extension/./src/presentation/content/index.ts"],"sourcesContent":["export function sendEvaluateListingCommand(payload) {\n    return new Promise((resolve, reject) => {\n        chrome.runtime.sendMessage({ type: \"evaluate-listing\", payload }, (response) => {\n            const error = chrome.runtime?.lastError;\n            if (error) {\n                reject(error);\n                return;\n            }\n            resolve(response);\n        });\n    });\n}\n","import { sendEvaluateListingCommand } from \"./messaging\";\nfunction parsePrice(text) {\n    if (!text)\n        return undefined;\n    const cleaned = text.replace(/[,$\\s]/g, \"\").match(/\\d+/);\n    return cleaned ? Number(cleaned[0]) : undefined;\n}\nexport function tryExtractFromLdJson() {\n    try {\n        const scripts = Array.from(document.querySelectorAll('script[type=\"application/ld+json\"]'));\n        for (const s of scripts) {\n            const txt = s.textContent || \"\";\n            if (txt.includes(\"Product\") || txt.includes(\"Vehicle\")) {\n                const obj = JSON.parse(txt);\n                const title = obj.name || obj.title || obj.headline;\n                const price = obj.offers?.price ? Number(obj.offers.price) : undefined;\n                const images = obj.image ? (Array.isArray(obj.image) ? obj.image : [obj.image]) : undefined;\n                return { title, price, images };\n            }\n        }\n    }\n    catch (e) {\n        // ignore parse errors\n    }\n    return null;\n}\nexport function tryExtractFromMeta() {\n    const title = document.querySelector('meta[property=\"og:title\"]')?.getAttribute('content') ||\n        document.querySelector('meta[name=\"title\"]')?.getAttribute('content');\n    const image = document.querySelector('meta[property=\"og:image\"]')?.getAttribute('content');\n    const priceMetaSelectors = [\n        'meta[property=\"product:price:amount\"]',\n        'meta[property=\"og:price:amount\"]',\n        'meta[property=\"og:price\"]',\n        'meta[itemprop=\"price\"]',\n        'meta[name=\"price\"]'\n    ];\n    const priceMetaContent = priceMetaSelectors\n        .map((selector) => document.querySelector(selector)?.getAttribute('content')?.trim())\n        .find((value) => !!value);\n    const priceText = priceMetaContent ?? Array.from(document.querySelectorAll('[data-testid], span, div'))\n        .map((el) => (el.textContent || \"\").trim())\n        .find((t) => /\\$\\s?\\d{1,3}(?:[\\,\\.]\\d{3})*/.test(t));\n    const price = parsePrice(priceText || null);\n    return { title: title || undefined, price, images: image ? [image] : undefined };\n}\nexport function tryExtractFromDom() {\n    // Best-effort DOM queries for Marketplace item pages\n    const titleEl = document.querySelector('[data-testid=\"marketplace_pane_title\"]') ||\n        document.querySelector('h1') || document.querySelector('h2');\n    const priceEl = Array.from(document.querySelectorAll('span, div')).find((el) => /\\$\\s?\\d{1,3}(?:[\\,\\.]\\d{3})*/.test((el.textContent || '').trim()));\n    // image selection: prefer data-src or src, filter out tiny icons and avatars\n    const imgEls = Array.from(document.querySelectorAll('img'))\n        .filter(img => {\n        const src = (img.getAttribute('src') || img.getAttribute('data-src') || '');\n        if (!src)\n            return false;\n        if (/facebook.com\\/rsrc/.test(src))\n            return false;\n        const width = Number(img.getAttribute('width')) || 0;\n        const height = Number(img.getAttribute('height')) || 0;\n        if (width && height && Math.min(width, height) < 60)\n            return false;\n        return true;\n    });\n    const title = titleEl?.textContent?.trim() || undefined;\n    const price = parsePrice(priceEl?.textContent || null);\n    const images = imgEls.length ? imgEls.slice(0, 6).map(i => (i.getAttribute('src') || i.getAttribute('data-src') || '')) : undefined;\n    // Simple heuristic for mileage/year inside text nodes\n    const bodyText = document.body.innerText || document.body.textContent || \"\";\n    const yearMatch = bodyText.match(/\\b(19|20)\\d{2}\\b/);\n    const mileageMatch = bodyText.match(/(\\d{1,3}(?:[\\,\\.]\\d{3})+)\\s*(miles|mi)\\b/i);\n    const year = yearMatch ? Number(yearMatch[0]) : undefined;\n    const mileage = mileageMatch ? parseInt(mileageMatch[1].replace(/[\\,\\.]/g, ''), 10) : undefined;\n    // VIN detection (17-char alphanumeric excluding I,O,Q) or labeled VIN\n    let vin;\n    const vinLabel = bodyText.match(/VIN\\s*[:#]?\\s*([A-HJ-NPR-Z0-9]{17})/i);\n    if (vinLabel)\n        vin = vinLabel[1];\n    else {\n        const vinCandidate = bodyText.match(/\\b([A-HJ-NPR-Z0-9]{17})\\b/);\n        if (vinCandidate)\n            vin = vinCandidate[1];\n    }\n    // Seller type heuristics\n    let sellerType;\n    if (/dealer|auto dealer|dealer inventory/i.test(bodyText))\n        sellerType = 'dealer';\n    else if (/private seller|owner selling|for sale by owner/i.test(bodyText))\n        sellerType = 'private';\n    return { title, price, images, year, mileage, vin, sellerType };\n}\nfunction extractIdFromUrl(url) {\n    try {\n        const u = new URL(url);\n        const parts = u.pathname.split('/').filter(Boolean);\n        const possible = parts.slice(-1)[0] || parts.slice(-2)[0];\n        return possible;\n    }\n    catch (e) {\n        return undefined;\n    }\n}\nfunction normalize(payload, url) {\n    return {\n        url,\n        title: payload.title,\n        price: payload.price,\n        images: payload.images,\n        year: payload.year,\n        mileage: payload.mileage,\n        vin: payload.vin,\n        sellerType: payload.sellerType\n    };\n}\nfunction isMarketplaceItemUrl(url) {\n    return /facebook\\.com\\/.+marketplace|facebook\\.com\\/.+\\/items\\//.test(url);\n}\nexport function initFacebookExtractor() {\n    const url = window.location.href;\n    if (!isMarketplaceItemUrl(url))\n        return;\n    let lastSentUrl = '';\n    async function extractAndSend() {\n        const urlNow = window.location.href;\n        if (urlNow === lastSentUrl)\n            return;\n        // Try strategies\n        let payload = tryExtractFromLdJson();\n        if (!payload)\n            payload = tryExtractFromMeta();\n        if (!payload)\n            payload = tryExtractFromDom();\n        if (!payload || (!payload.title && !payload.price)) {\n            // nothing meaningful extracted\n            return;\n        }\n        const listing = normalize(payload, urlNow);\n        try {\n            // Persist pre-extracted listing in chrome.storage.local so background scraper can use it if needed\n            const key = `preextracted_listings`;\n            const toStore = {};\n            toStore[urlNow] = listing;\n            chrome.storage.local.get([key], (existing = {}) => {\n                const aggregated = existing[key] || {};\n                aggregated[urlNow] = listing;\n                const payload = {};\n                payload[key] = aggregated;\n                chrome.storage.local.set(payload, () => {\n                    // fire evaluation using only the url (existing pipeline expects only url)\n                    sendEvaluateListingCommand({ url: listing.url })\n                        .then(() => {\n                        lastSentUrl = urlNow;\n                        console.info('Facebook extractor: sent listing for evaluation', listing.url);\n                    })\n                        .catch((e) => console.error('Facebook extractor: failed to send listing', e));\n                });\n            });\n        }\n        catch (e) {\n            console.error('Facebook extractor: failed to send listing', e);\n        }\n    }\n    // Run once after load\n    setTimeout(extractAndSend, 800);\n    // Observe navigation changes in SPA and DOM mutations\n    let timer;\n    const observer = new MutationObserver(() => {\n        if (timer)\n            window.clearTimeout(timer);\n        timer = window.setTimeout(() => void extractAndSend(), 600);\n    });\n    observer.observe(document.body, { childList: true, subtree: true });\n    // Cleanup when page unloads\n    window.addEventListener('beforeunload', () => observer.disconnect());\n}\n","import { sendEvaluateListingCommand } from \"./messaging\";\nimport { initFacebookExtractor } from \"./facebook.extractor\";\nconst currentUrl = window.location.href;\nasync function showAssessmentOverlay() {\n    try {\n        const response = await sendEvaluateListingCommand({ url: currentUrl });\n        const assessment = response?.assessment;\n        // Create a small overlay in the page to show the assessment summary\n        const container = document.createElement(\"div\");\n        container.id = \"ai-deal-insight-overlay\";\n        container.style.position = \"fixed\";\n        container.style.top = \"12px\";\n        container.style.right = \"12px\";\n        container.style.zIndex = \"999999\";\n        container.style.background = \"rgba(0,0,0,0.85)\";\n        container.style.color = \"#fff\";\n        container.style.padding = \"10px 14px\";\n        container.style.borderRadius = \"8px\";\n        container.style.fontFamily = \"Arial, sans-serif\";\n        container.style.boxShadow = \"0 6px 18px rgba(0,0,0,0.35)\";\n        container.style.maxWidth = \"320px\";\n        if (!assessment) {\n            container.innerText = \"AI evaluation did not return a result.\";\n        }\n        else {\n            const title = document.createElement(\"div\");\n            title.style.fontWeight = \"700\";\n            title.style.marginBottom = \"6px\";\n            title.innerText = `Deal: ${assessment.verdict?.toUpperCase() ?? \"N/A\"}`;\n            const score = document.createElement(\"div\");\n            score.style.fontSize = \"22px\";\n            score.style.fontWeight = \"800\";\n            score.style.marginBottom = \"6px\";\n            score.innerText = `Score: ${Math.round(assessment.overallScore ?? 0)}`;\n            const rationale = document.createElement(\"div\");\n            rationale.style.fontSize = \"12px\";\n            rationale.style.opacity = \"0.9\";\n            rationale.innerText = (assessment.rationale || []).slice(0, 3).join(\" \\n\") || \"No details\";\n            container.appendChild(title);\n            container.appendChild(score);\n            container.appendChild(rationale);\n        }\n        const closeBtn = document.createElement(\"button\");\n        closeBtn.innerText = \"×\";\n        closeBtn.title = \"Close\";\n        closeBtn.style.position = \"absolute\";\n        closeBtn.style.top = \"6px\";\n        closeBtn.style.right = \"8px\";\n        closeBtn.style.background = \"transparent\";\n        closeBtn.style.border = \"none\";\n        closeBtn.style.color = \"#fff\";\n        closeBtn.style.fontSize = \"14px\";\n        closeBtn.style.cursor = \"pointer\";\n        closeBtn.addEventListener(\"click\", () => container.remove());\n        container.appendChild(closeBtn);\n        document.body.appendChild(container);\n    }\n    catch (error) {\n        console.error(\"Failed to trigger evaluation\", error);\n    }\n}\n// Initialize extraction for Facebook Marketplace if applicable\ntry {\n    initFacebookExtractor();\n}\ncatch (e) {\n    // ignore errors from extractor\n}\nvoid showAssessmentOverlay();\n"],"names":["sendEvaluateListingCommand","payload","Promise","resolve","reject","chrome","runtime","sendMessage","type","response","error","lastError","parsePrice","text","cleaned","replace","match","Number","undefined","currentUrl","window","location","href","url","test","timer","lastSentUrl","async","extractAndSend","urlNow","scripts","Array","from","document","querySelectorAll","s","txt","textContent","includes","obj","JSON","parse","title","name","headline","price","offers","images","image","isArray","e","tryExtractFromLdJson","querySelector","getAttribute","map","selector","trim","find","value","el","t","tryExtractFromMeta","titleEl","priceEl","imgEls","filter","img","src","width","height","Math","min","length","slice","i","bodyText","body","innerText","yearMatch","mileageMatch","year","mileage","parseInt","vin","vinLabel","vinCandidate","sellerType","tryExtractFromDom","listing","normalize","key","storage","local","get","existing","aggregated","set","then","console","info","catch","setTimeout","observer","MutationObserver","clearTimeout","observe","childList","subtree","addEventListener","disconnect","initFacebookExtractor","assessment","container","createElement","id","style","position","top","right","zIndex","background","color","padding","borderRadius","fontFamily","boxShadow","maxWidth","fontWeight","marginBottom","verdict","toUpperCase","score","fontSize","round","overallScore","rationale","opacity","join","appendChild","closeBtn","border","cursor","remove","showAssessmentOverlay"],"sourceRoot":""}