(()=>{"use strict";function e(e){return new Promise((t,r)=>{chrome.runtime.sendMessage({type:"evaluate-listing",payload:e},e=>{const o=chrome.runtime?.lastError;o?r(o):t(e)})})}function t(e){if(!e)return;const t=e.replace(/[,$\s]/g,"").match(/\d+/);return t?Number(t[0]):void 0}const r=window.location.href;try{!function(){if(r=window.location.href,!/facebook\.com\/.+marketplace|facebook\.com\/.+\/items\//.test(r))return;var r;let o,n="";async function i(){const r=window.location.href;if(r===n)return;let o=function(){try{const e=Array.from(document.querySelectorAll('script[type="application/ld+json"]'));for(const t of e){const e=t.textContent||"";if(e.includes("Product")||e.includes("Vehicle")){const t=JSON.parse(e);return{title:t.name||t.title||t.headline,price:t.offers?.price?Number(t.offers.price):void 0,images:t.image?Array.isArray(t.image)?t.image:[t.image]:void 0}}}}catch(e){}return null}();if(o||(o=function(){const e=document.querySelector('meta[property="og:title"]')?.getAttribute("content")||document.querySelector('meta[name="title"]')?.getAttribute("content"),r=document.querySelector('meta[property="og:image"]')?.getAttribute("content");return{title:e||void 0,price:t((['meta[property="product:price:amount"]','meta[property="og:price:amount"]','meta[property="og:price"]','meta[itemprop="price"]','meta[name="price"]'].map(e=>document.querySelector(e)?.getAttribute("content")?.trim()).find(e=>!!e)??Array.from(document.querySelectorAll("[data-testid], span, div")).map(e=>(e.textContent||"").trim()).find(e=>/\$\s?\d{1,3}(?:[\,\.]\d{3})*/.test(e)))||null),images:r?[r]:void 0}}()),o||(o=function(){const e=document.querySelector('[data-testid="marketplace_pane_title"]')||document.querySelector("h1")||document.querySelector("h2"),r=Array.from(document.querySelectorAll("span, div")).find(e=>/\$\s?\d{1,3}(?:[\,\.]\d{3})*/.test((e.textContent||"").trim())),o=Array.from(document.querySelectorAll("img")).filter(e=>{const t=e.getAttribute("src")||e.getAttribute("data-src")||"";if(!t)return!1;if(/facebook.com\/rsrc/.test(t))return!1;const r=Number(e.getAttribute("width"))||0,o=Number(e.getAttribute("height"))||0;return!(r&&o&&Math.min(r,o)<60)}),n=e?.textContent?.trim()||void 0,i=t(r?.textContent||null),c=o.length?o.slice(0,6).map(e=>e.getAttribute("src")||e.getAttribute("data-src")||""):void 0,a=document.body.innerText||document.body.textContent||"",l=a.match(/\b(19|20)\d{2}\b/),s=a.match(/(\d{1,3}(?:[\,\.]\d{3})+)\s*(miles|mi)\b/i),d=l?Number(l[0]):void 0,u=s?parseInt(s[1].replace(/[\,\.]/g,""),10):void 0;let m;const p=a.match(/VIN\s*[:#]?\s*([A-HJ-NPR-Z0-9]{17})/i);if(p)m=p[1];else{const e=a.match(/\b([A-HJ-NPR-Z0-9]{17})\b/);e&&(m=e[1])}let y;return/dealer|auto dealer|dealer inventory/i.test(a)?y="dealer":/private seller|owner selling|for sale by owner/i.test(a)&&(y="private"),{title:n,price:i,images:c,year:d,mileage:u,vin:m,sellerType:y}}()),!o||!o.title&&!o.price)return;const i=function(e,t){return{url:t,title:e.title,price:e.price,images:e.images,year:e.year,mileage:e.mileage,vin:e.vin,sellerType:e.sellerType}}(o,r);try{const t="preextracted_listings";chrome.storage.local.get([t],(o={})=>{const c=o[t]||{};c[r]=i;const a={};a[t]=c,chrome.storage.local.set(a,()=>{e({url:i.url}).then(()=>{n=r,console.info("Facebook extractor: sent listing for evaluation",i.url)}).catch(e=>console.error("Facebook extractor: failed to send listing",e))})})}catch(e){console.error("Facebook extractor: failed to send listing",e)}}setTimeout(i,800);const c=new MutationObserver(()=>{o&&window.clearTimeout(o),o=window.setTimeout(()=>{i()},600)});c.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>c.disconnect())}()}catch(e){}!async function(){try{const t=await e({url:r}),o=t?.assessment,n=document.createElement("div");if(n.id="ai-deal-insight-overlay",n.style.position="fixed",n.style.top="12px",n.style.right="12px",n.style.zIndex="999999",n.style.background="rgba(0,0,0,0.85)",n.style.color="#fff",n.style.padding="10px 14px",n.style.borderRadius="8px",n.style.fontFamily="Arial, sans-serif",n.style.boxShadow="0 6px 18px rgba(0,0,0,0.35)",n.style.maxWidth="320px",o){const e=document.createElement("div");e.style.fontWeight="700",e.style.marginBottom="6px",e.innerText=`Deal: ${o.verdict?.toUpperCase()??"N/A"}`;const t=document.createElement("div");t.style.fontSize="22px",t.style.fontWeight="800",t.style.marginBottom="6px",t.innerText=`Score: ${Math.round(o.overallScore??0)}`;const r=document.createElement("div");r.style.fontSize="12px",r.style.opacity="0.9",r.innerText=(o.rationale||[]).slice(0,3).join(" \n")||"No details",n.appendChild(e),n.appendChild(t),n.appendChild(r)}else n.innerText="AI evaluation did not return a result.";const i=document.createElement("button");i.innerText="Ã—",i.title="Close",i.style.position="absolute",i.style.top="6px",i.style.right="8px",i.style.background="transparent",i.style.border="none",i.style.color="#fff",i.style.fontSize="14px",i.style.cursor="pointer",i.addEventListener("click",()=>n.remove()),n.appendChild(i),document.body.appendChild(n)}catch(e){console.error("Failed to trigger evaluation",e)}}()})();
//# sourceMappingURL=content.js.map