(()=>{"use strict";var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};function t(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}function r(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o}function i(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}function s(e){return"function"==typeof e}function o(e){var t=e(function(e){Error.call(e),e.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var a=o(function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}});function c(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var l=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,o,c,l;if(!this.closed){this.closed=!0;var u=this._parentage;if(u)if(this._parentage=null,Array.isArray(u))try{for(var p=r(u),f=p.next();!f.done;f=p.next())f.value.remove(this)}catch(t){e={error:t}}finally{try{f&&!f.done&&(t=p.return)&&t.call(p)}finally{if(e)throw e.error}}else u.remove(this);var d=this.initialTeardown;if(s(d))try{d()}catch(e){l=e instanceof a?e.errors:[e]}var y=this._finalizers;if(y){this._finalizers=null;try{for(var m=r(y),v=m.next();!v.done;v=m.next()){var g=v.value;try{h(g)}catch(e){l=null!=l?l:[],e instanceof a?l=i(i([],n(l)),n(e.errors)):l.push(e)}}}catch(e){o={error:e}}finally{try{v&&!v.done&&(c=m.return)&&c.call(m)}finally{if(o)throw o.error}}}if(l)throw new a(l)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)h(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&c(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&c(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),u=l.EMPTY;function p(e){return e instanceof l||e&&"closed"in e&&s(e.remove)&&s(e.add)&&s(e.unsubscribe)}function h(e){s(e)?e():e.unsubscribe()}var f=null,d=null,y=void 0,m=!1,v=!1,g={setTimeout:function(e,t){for(var r=[],s=2;s<arguments.length;s++)r[s-2]=arguments[s];var o=g.delegate;return(null==o?void 0:o.setTimeout)?o.setTimeout.apply(o,i([e,t],n(r))):setTimeout.apply(void 0,i([e,t],n(r)))},clearTimeout:function(e){var t=g.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function b(){}var w=_("C",void 0,void 0);function _(e,t,r){return{kind:e,value:t,error:r}}var x=null;function S(e){if(m){var t=!x;if(t&&(x={errorThrown:!1,error:null}),e(),t){var r=x,n=r.errorThrown,i=r.error;if(x=null,n)throw i}}else e()}var k=function(e){function r(t){var r=e.call(this)||this;return r.isStopped=!1,t?(r.destination=t,p(t)&&t.add(r)):r.destination=T,r}return t(r,e),r.create=function(e,t,r){return new O(e,t,r)},r.prototype.next=function(e){this.isStopped?E(function(e){return _("N",e,void 0)}(e),this):this._next(e)},r.prototype.error=function(e){this.isStopped?E(_("E",void 0,e),this):(this.isStopped=!0,this._error(e))},r.prototype.complete=function(){this.isStopped?E(w,this):(this.isStopped=!0,this._complete())},r.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},r.prototype._next=function(e){this.destination.next(e)},r.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},r.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},r}(l),P=Function.prototype.bind;function A(e,t){return P.call(e,t)}var L=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){z(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){z(e)}else z(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){z(e)}},e}(),O=function(e){function r(t,r,n){var i,o,a=e.call(this)||this;return s(t)||!t?i={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:a&&v?((o=Object.create(t)).unsubscribe=function(){return a.unsubscribe()},i={next:t.next&&A(t.next,o),error:t.error&&A(t.error,o),complete:t.complete&&A(t.complete,o)}):i=t,a.destination=new L(i),a}return t(r,e),r}(k);function z(e){var t;m?(t=e,m&&x&&(x.errorThrown=!0,x.error=t)):function(e){g.setTimeout(function(){if(!f)throw e;f(e)})}(e)}function E(e,t){var r=d;r&&g.setTimeout(function(){return r(e,t)})}var T={closed:!0,next:b,error:function(e){throw e},complete:b},j="function"==typeof Symbol&&Symbol.observable||"@@observable";function $(e){return e}var M=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(e,t,r){var n,i=this,o=(n=e)&&n instanceof k||function(e){return e&&s(e.next)&&s(e.error)&&s(e.complete)}(n)&&p(n)?e:new O(e,t,r);return S(function(){var e=i,t=e.operator,r=e.source;o.add(t?t.call(o,r):r?i._subscribe(o):i._trySubscribe(o))}),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var r=this;return new(t=I(t))(function(t,n){var i=new O({next:function(t){try{e(t)}catch(e){n(e),i.unsubscribe()}},error:n,complete:t});r.subscribe(i)})},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[j]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return(0===(r=e).length?$:1===r.length?r[0]:function(e){return r.reduce(function(e,t){return t(e)},e)})(this);var r},e.prototype.toPromise=function(e){var t=this;return new(e=I(e))(function(e,r){var n;t.subscribe(function(e){return n=e},function(e){return r(e)},function(){return e(n)})})},e.create=function(t){return new e(t)},e}();function I(e){var t;return null!==(t=null!=e?e:y)&&void 0!==t?t:Promise}var C=o(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),F=function(e){function n(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return t(n,e),n.prototype.lift=function(e){var t=new V(this,this);return t.operator=e,t},n.prototype._throwIfClosed=function(){if(this.closed)throw new C},n.prototype.next=function(e){var t=this;S(function(){var n,i;if(t._throwIfClosed(),!t.isStopped){t.currentObservers||(t.currentObservers=Array.from(t.observers));try{for(var s=r(t.currentObservers),o=s.next();!o.done;o=s.next())o.value.next(e)}catch(e){n={error:e}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}}})},n.prototype.error=function(e){var t=this;S(function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var r=t.observers;r.length;)r.shift().error(e)}})},n.prototype.complete=function(){var e=this;S(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}})},n.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(n.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),n.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},n.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},n.prototype._innerSubscribe=function(e){var t=this,r=this,n=r.hasError,i=r.isStopped,s=r.observers;return n||i?u:(this.currentObservers=null,s.push(e),new l(function(){t.currentObservers=null,c(s,e)}))},n.prototype._checkFinalizedStatuses=function(e){var t=this,r=t.hasError,n=t.thrownError,i=t.isStopped;r?e.error(n):i&&e.complete()},n.prototype.asObservable=function(){var e=new M;return e.source=this,e},n.create=function(e,t){return new V(e,t)},n}(M),V=function(e){function r(t,r){var n=e.call(this)||this;return n.destination=t,n.source=r,n}return t(r,e),r.prototype.next=function(e){var t,r;null===(r=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===r||r.call(t,e)},r.prototype.error=function(e){var t,r;null===(r=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===r||r.call(t,e)},r.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},r.prototype._subscribe=function(e){var t,r;return null!==(r=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==r?r:u},r}(F);let K=(e=21)=>{let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t};class R{constructor(e,t){this.domains=t,this.id=e}get idValue(){return this.id}supportsUrl(e){return this.domains.some(t=>e.includes(t))}async fetchListing(e){return{id:K(),source:this.id,url:e,title:"Placeholder AutoTrader Listing",description:"Sample description for prototype workflow.",price:25e3,images:[],metadata:{}}}async streamListings(e,t){t({id:K(),source:this.id,url:"https://www.autotrader.com/cars-for-sale/sample",title:`Mock ${e.make??"Vehicle"}`,description:"Generated listing for testing.",price:e.maxPrice??2e4,images:[],metadata:{criteria:e}})}}class U{constructor(e,t){this.domains=t,this.id=e}get idValue(){return this.id}supportsUrl(e){return this.domains.some(t=>e.includes(t))}async fetchListing(e){return{id:K(),source:this.id,url:e,title:"Placeholder Facebook Marketplace Listing",description:"Sample description for Facebook Marketplace.",price:15e3,images:[],metadata:{}}}async streamListings(e,t){t({id:K(),source:this.id,url:"https://www.facebook.com/marketplace/item/sample",title:`FB Mock ${e.make??"Vehicle"}`,description:"Generated listing for testing.",price:e.maxPrice??12e3,images:[],metadata:{criteria:e}})}}class N{supports(e){return e.images.length>0}async analyze(e){const t=0===e.images.length?[]:[{code:"image-quality",severity:"low",summary:"Visual review recommended",evidence:e.images.slice(0,2).map(e=>e.url)}];return{flags:t,rationale:t.length?["Images analyzed; no obvious damage detected."]:[]}}}const B=["salvage","as-is","rebuilt","flood","frame damage"];class G{supports(e){return e.description.length>0}async analyze(e){const t=e.description.toLowerCase(),r=B.filter(e=>t.includes(e));return 0===r.length?{rationale:["Description review: no red flag keywords found."]}:{flags:r.map(t=>({code:`keyword:${t}`,severity:"medium",summary:`Listing mentions ${t}`,evidence:[e.description]})),rationale:[`Listing description contains: ${r.join(", ")}`]}}}class Y{supports(e){return!0}async analyze(e){const t=1.05*e.price;return{pricing:{predictedMarketPrice:t,percentile:e.price/Math.max(t,1),comparableListings:[]},rationale:[`Baseline pricing model estimates $${t.toFixed(0)}`]}}}const q=class{static create(e){return e.map(e=>{switch(e.type){case"autotrader":return new R(e.id,e.domains);case"facebook":return new U(e.id,e.domains);default:throw new Error(`Unsupported scraper type: ${e.type}`)}})}}.create([{id:"autotrader",domains:["autotrader.com"],type:"autotrader"},{id:"facebook",domains:["facebook.com","facebookmarketplace.com"],type:"facebook"}]),D=new class{constructor(e){this.listing$=new F,this.sources=e}stream(e){return Promise.all(this.sources.map(t=>t.streamListings(e,e=>this.listing$.next(e)))).catch(e=>{console.error("Listing stream error",e)}),this.listing$.asObservable()}fetch(e){const t=this.sources.find(t=>t.supportsUrl(e));return t?new Promise((r,n)=>{try{const i="preextracted_listings";chrome.storage.local.get([i],s=>{const o=(s&&s[i]||{})[e];if(o)try{const n={id:o.id||`${t?.id??"unknown"}:${e}`,source:o.source||t?.id||"unknown",url:e,title:o.title||o.name||"",description:o.description||"",price:"number"==typeof o.price?o.price:Number(o.price)||0,mileage:o.mileage,year:o.year,make:o.make,model:o.model,trim:o.trim,location:o.location,postedAt:o.postedAt,images:(o.images||[]).map((e,t)=>({url:e,altText:`image-${t}`})),metadata:o.metadata||{}};return void r(n)}catch(e){console.warn("Failed to use preextracted listing, falling back to scraper",e)}t.fetchListing(e).then(r).catch(n)})}catch(i){t.fetchListing(e).then(r).catch(n)}}):Promise.reject(new Error(`No scraper found for url: ${e}`))}}(q),W=new class{constructor(e){this.analyzers=e}async analyze(e){return(await Promise.all(this.analyzers.filter(t=>t.supports(e)).map(t=>t.analyze(e)))).reduce((e,t)=>({...e,...t,flags:[...e.flags??[],...t.flags??[]],rationale:[...e.rationale??[],...t.rationale??[]]}),{flags:[],rationale:[]})}}([new class{constructor(){this.analyzers=[new Y,new N,new G]}supports(e){return!0}async analyze(e){const t=await Promise.all(this.analyzers.filter(t=>t.supports(e)).map(t=>t.analyze(e))),r=[],n=[];return{...t.reduce((e,t)=>(t.flags&&r.push(...t.flags),t.rationale&&n.push(...t.rationale),{...e,...t}),{}),flags:r,rationale:n}}}]),H=new class{constructor(e){this.evaluator=e}evaluate(e,t){return this.evaluator.evaluate(e,t)}}(new class{evaluate(e,t){const r=t.pricing?.predictedMarketPrice??e.price,n=r-e.price,i=t.flags??[],s=Math.max(0,Math.min(100,50+n/100-10*i.filter(e=>"high"===e.severity||"critical"===e.severity).length)),o=s>=80?"great":s>=65?"good":s>=50?"fair":"poor";return{listingId:e.id,overallScore:s,verdict:o,pricing:{predictedMarketPrice:r,percentile:t.pricing?.percentile??.5,comparableListings:t.pricing?.comparableListings??[]},maintenance:t.maintenance??{annualCost:0,reliabilityScore:0,commonIssues:[]},flags:i,rationale:t.rationale??[],modelVersion:"basic-1.0"}}}),J=new class{constructor(e,t){this.listingRepository=e,this.assessmentRepository=t}saveListing(e){return this.listingRepository.upsertListing(e)}saveAssessment(e){return this.assessmentRepository.saveAssessment(e)}async getListingWithAssessment(e){const[t,r]=await Promise.all([this.listingRepository.getListingById(e),this.assessmentRepository.getAssessment(e)]);return{listing:t,assessment:r}}}(new class{constructor(){this.storageKey="listings"}async upsertListing(e){const t=await this.listTrackedListings(),r=t.findIndex(t=>t.id===e.id);return r>=0?t[r]=e:t.push(e),this.save(t)}async getListingById(e){return(await this.listTrackedListings()).find(t=>t.id===e)}async listTrackedListings(){return await this.getStorageValue(this.storageKey)??[]}async save(e){return new Promise(t=>{chrome.storage.local.set({[this.storageKey]:e},()=>t())})}async getStorageValue(e){return new Promise(t=>{chrome.storage.local.get(e,r=>t(r[e]))})}},new class{constructor(){this.storageKey="assessments"}async saveAssessment(e){const t=await this.getAll();return t[e.listingId]=e,new Promise(e=>{chrome.storage.local.set({[this.storageKey]:t},()=>e())})}async getAssessment(e){return(await this.getAll())[e]}async getAll(){return new Promise(e=>{chrome.storage.local.get(this.storageKey,t=>{e(t[this.storageKey]??{})})})}}),Q=new class{constructor(e){this.channels=new Map,this.events$=new F,e.forEach(e=>this.channels.set(e.id,e)),this.events$.subscribe(e=>{Promise.all(Array.from(this.channels.values()).map(t=>t.notify(e))).catch(e=>console.error("Notification error",e))})}publish(e){this.events$.next(e)}notifyAssessment(e){this.publish({type:"deal-update",payload:e})}}([]),X=new class{constructor(){this.subject=new F}asObservable(){return this.subject.asObservable()}publish(e){this.subject.next(e)}},Z=new class{constructor(e,t,r,n,i){this.scraper=e,this.analyzer=t,this.evaluator=r,this.persistence=n,this.notification=i}async execute(e){const t=await this.scraper.fetch(e.url),r=this.persistence.saveListing(t).catch(e=>{console.error("Failed to save listing",e)}),n=await this.runAnalysis(t);return this.persistence.saveAssessment(n).catch(e=>{console.error("Failed to save assessment",e)}),this.notification.notifyAssessment(n),r.catch(()=>{}),n}async runAnalysis(e){const t=await this.analyzer.analyze(e);return this.evaluator.evaluate(e,t)}}(D,W,H,J,Q);D.stream({make:"Prototype",maxPrice:22e3}).subscribe(e=>{console.info("Prototype stream listing",e),X.publish({type:"listing-discovered",listing:e})}),X.asObservable().subscribe(e=>{console.info("Listing event",e)}),Q.publish({type:"deal-update",payload:{listingId:"bootstrap",overallScore:0,verdict:"fair",pricing:{predictedMarketPrice:0,percentile:0,comparableListings:[]},maintenance:{annualCost:0,reliabilityScore:0,commonIssues:[]},flags:[],rationale:["Notification manager initialized."],modelVersion:"bootstrap"}}),chrome.runtime.onMessage.addListener((e,t,r)=>{if("evaluate-listing"===e?.type)return Z.execute(e.payload).then(e=>r({assessment:e})).catch(e=>{console.error("Evaluation failed",e),r({error:e.message})}),!0})})();
//# sourceMappingURL=background.js.map